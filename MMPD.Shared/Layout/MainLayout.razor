@inherits LayoutComponentBase
@using Telerik.Blazor
@using Telerik.Blazor.Components
@implements IDisposable
@inject NavigationManager NavigationManager

@inject MMPD.Shared.Services.LayoutState LayoutState


<TelerikRootComponent>
    <div class="main-layout-container">
        
        <header class="main-layout-header" >
            @if (IsStoreSpecificPage())
            {
                <StoreTitleCard StoreInfo="GetStoreInfo()" />
            }
            else if (IsCorpPage()) {
                <CorpHeadCard Info="LayoutState.HeaderInfo" />
            }
            else
            {
                <HeadTitleCard Info="LayoutState.HeaderInfo" />
            }
        </header>

        <main class="main-layout-content no-scrollbar">
            @Body
        </main>

        <footer class="main-layout-footer">
            <FooterNav Items="LayoutState.FooterItems" />
        </footer>

    </div>
</TelerikRootComponent>

@code {
    protected override void OnInitialized()
    {
        LayoutState.OnChange += OnStateChanged;
    }

    private async void OnStateChanged()
    {
        // Safely update the UI when the state changes
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        // Unsubscribe to prevent memory leaks
        LayoutState.OnChange -= OnStateChanged;
    }

    private bool IsStoreSpecificPage()
    {
        var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);

        // Check if the current path matches the store-specific page patterns
        return relativePath.StartsWith("metalmart/", StringComparison.OrdinalIgnoreCase) ||
               relativePath.StartsWith("servicecenter/", StringComparison.OrdinalIgnoreCase);
    }

    private bool IsCorpPage()
    {
        var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri).ToLower();

        // Check if the current path is home or corporate related
        return string.IsNullOrEmpty(relativePath) || 
               relativePath == "home" || 
               relativePath.StartsWith("corporate");
    }

    private StoreTitleCard.StoreTitleCardModel? GetStoreInfo()
    {
        if (LayoutState.HeaderInfo == null)
            return null;

        // Convert HeaderInfo to StoreTitleCardModel
        return new StoreTitleCard.StoreTitleCardModel
        {
            Title = LayoutState.HeaderInfo.Title ?? string.Empty,
            StoreManager = LayoutState.HeaderInfo.StoreManager ?? string.Empty,
            AreaManager = LayoutState.HeaderInfo.AreaManager ?? string.Empty
        };
    }
}

<style>
    .main-layout-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

    .main-layout-header {
        flex-shrink: 0;
    }

    .main-layout-footer {
        flex-shrink: 0;
    }

    .main-layout-content {
        flex: 1;
        overflow-y: hidden;
        min-height: 0;
    }
</style>